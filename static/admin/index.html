<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
  </head>
  <body>
    <!-- HELPER: tangkap token dari callback & simpan ke localStorage -->
    <script>
      (function () {
        // 1) listener untuk semua format postMessage
        window.addEventListener("message", function (ev) {
          try {
            var token = null;
            if (typeof ev.data === "string" && ev.data.indexOf("authorization:github:success:") === 0) {
              token = ev.data.replace("authorization:github:success:", "");
            } else if (ev.data && typeof ev.data === "object" && ev.data.token) {
              token = ev.data.token;
            }
            if (token) {
              localStorage.setItem("decap-cms-user", JSON.stringify({ token: token }));
              localStorage.setItem("netlify-cms-user", JSON.stringify({ token: token }));
              // reload sekali supaya Decap baca user dari storage
              if (!sessionStorage.getItem("cms-reloaded")) {
                sessionStorage.setItem("cms-reloaded", "1");
                location.reload();
              }
            }
          } catch (e) {}
        });

        // 2) fallback: kalau token dikirim via query/hash (?token=...), simpan juga
        try {
          var params = new URLSearchParams(location.search);
          var tk = params.get("token") || (location.hash || "").replace(/^#token=/, "");
          if (tk) {
            localStorage.setItem("decap-cms-user", JSON.stringify({ token: tk }));
            localStorage.setItem("netlify-cms-user", JSON.stringify({ token: tk }));
            params.delete("token");
            history.replaceState({}, "", location.pathname + (params.toString() ? "?" + params.toString() : ""));
          }
        } catch (e) {}
      })();
    </script>

    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js"></script>
  </body>
</html>
